<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Recuperar acceso | tâches</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --c1:#667eea;
      --c2:#764ba2;
      --ok:#16a34a;
      --err:#dc2626;
      --bd:#e5e7eb;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--c1), var(--c2));
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .card {
      background: #fff;
      max-width: 420px;
      width: 100%;
      padding: 32px;
      border-radius: 20px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 24px;
      text-align: center;
    }
    p.hint {
      margin: 0 0 20px;
      color: #6b7280;
      text-align: center;
    }
    .group { margin-bottom: 18px; }
    label { display:block; font-weight:600; margin-bottom:6px; }
    input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--bd);
      border-radius: 10px;
      outline: none;
      font-size: 14px;
    }
    input:focus { border-color: var(--c1); }
    .btn-gradient {
      width: 100%;
      border-radius: 50px;
      background: linear-gradient(135deg, var(--c1), var(--c2));
      color: #fff;
      font-weight: 600;
      border: none;
      padding: 12px;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.3s;
    }
    .btn-gradient:hover {
      transform: scale(1.03);
      box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
    }
    .btn-dark {
      width: 100%;
      border-radius: 50px;
      background: #111;
      color: #fff;
      font-weight: 600;
      border: none;
      padding: 12px;
      font-size: 15px;
      cursor: pointer;
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .msg {
      margin: 12px 0;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      display: none;
    }
    .msg.ok { background:#ecfdf5; color:#065f46; display:block; }
    .msg.err { background:#fef2f2; color:#7f1d1d; display:block; }
    .muted {
      color: #6b7280;
      font-size: 13px;
      text-align: center;
      margin-top: 16px;
    }
    .muted a { color: var(--c2); text-decoration: none; }
    hr { margin: 20px 0; border:none; border-top:1px solid var(--bd); }
  </style>
</head>
<body>
  <div class="card">
    <h1>Recuperar acceso</h1>
    <p class="hint">Te enviaremos un código al <b>correo de recuperación</b> si lo tienes configurado.</p>

    <div class="group">
      <label for="email">Correo de inicio de sesión</label>
      <input id="email" type="email" placeholder="tu@correo.com" autocomplete="email" required>
    </div>

    <div class="row">
      <button id="sendBtn" class="btn-gradient">Enviar código</button>
      <button type="button" class="btn-dark" onclick="location.href='/'">Volver</button>
    </div>

    <div id="sendMsg" class="msg"></div>

    <hr>

    <div class="group">
      <label for="code">Ingresa el código</label>
      <input id="code" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="000000">
    </div>
    <button id="verifyBtn" class="btn-gradient">Validar código e ingresar</button>

    <div id="verifyMsg" class="msg"></div>

    <p class="muted">¿No tienes correo de recuperación? <a href="/contacto" target="_blank">Contacta con soporte</a>.</p>
  </div>

  <script>
    const sendBtn = document.getElementById("sendBtn");
    const verifyBtn = document.getElementById("verifyBtn");
    const sendMsg = document.getElementById("sendMsg");
    const verifyMsg = document.getElementById("verifyMsg");

    function showMsg(el, text, ok=true){
      el.className = "msg " + (ok ? "ok" : "err");
      el.textContent = text;
      el.style.display = "block";
    }

    sendBtn.addEventListener("click", async () => {
      sendMsg.style.display = "none";
      const email = document.getElementById("email").value.trim();
      if(!email) return showMsg(sendMsg, "Ingresa tu correo", false);

      try {
        const res = await fetch("/api/recovery/send-code", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ email })
        });

        const data = await res.json();

        if(res.status === 429){
          return showMsg(sendMsg, data.message || "Espera antes de solicitar otro código", false);
        }

        if(data.sent){
          showMsg(sendMsg, "Si tu cuenta tiene correo de recuperación, te enviamos un código. Revisa tu bandeja.");
        } else {
          if (data.reason === "No tiene correo de recuperación") {
            showMsg(sendMsg, "Tu cuenta no tiene correo de recuperación configurado. Contacta con soporte.", false);
          } else {
            showMsg(sendMsg, "Si tu cuenta existe y tiene recuperación, recibirá un código.");
          }
        }
      } catch (e) {
        showMsg(sendMsg, "Error al enviar el código", false);
      }
    });

    verifyBtn.addEventListener("click", async () => {
      verifyMsg.style.display = "none";
      const email = document.getElementById("email").value.trim();
      const code = document.getElementById("code").value.trim();

      if(!email || !code) return showMsg(verifyMsg, "Ingresa tu correo y el código", false);

      try {
        const res = await fetch("/api/recovery/verify-code", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ email, code })
        });
        const data = await res.json();

        if(!data.success){
          return showMsg(verifyMsg, data.message || "Código inválido o expirado", false);
        }

        window.location.href = data.redirect || "/mensajeRe";
      } catch (e) {
        showMsg(verifyMsg, "Error verificando el código", false);
      }
    });
  </script>
</body>
</html>
